---
# Author: Jorge Hevia
# jmhev@outlook.com
# Ansible Version: 2.3.1
# What does this role do?: This role will create the users given in the
#   userCreation/vars/main.yml file so they can connect throught ssh
#   using a new generated rsa-4096 key
# What does this playbook do?: this playbook creates the users
# found in role/vars/main.yml-
- name: Creates the users from {role}/vars/main.yml
  user:
    name: "{{ item }}"
    group: users
    generate_ssh_key: yes
    ssh_key_bits: 4096
    ssh_key_file: .ssh/{{ item }}
    state: present
  with_items:
    - "{{ users }}"
- name: adds the rsa key to ~/.ssh/known_hosts
  copy:
    remote_src: yes
    src: /home/{{item}}/.ssh/{{item}}.pub
    dest: /home/{{item}}/.ssh/known_hosts
    owner: "{{ item }}"
    mode: 0644
  with_items:
    - "{{ users }}"
- name: fetchs the public key from the server and stores it on {role}/tmp
  fetch:
    src: /home/{{item}}/.ssh/{{item}}
    dest: userCreation/tmp/{{item}}.pem
    flat: yes
  with_items:
    - "{{ users }}"